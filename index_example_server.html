<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-time Speech Transcription</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Poppins", sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
            background-color: #e6e7ee;
            color: #44476a;
        }

        h1 {
            font-weight: 600;
            font-size: 2.2rem;
            margin-bottom: 30px;
            color: #31344b;
        }

        #controls {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        button {
            font-family: "Poppins", sans-serif;
            background-color: #e6e7ee;
            color: #44476a;
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 5px 5px 10px #c8c9d1, -5px -5px 10px #ffffff;
            outline: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:active:not(:disabled),
        button.active {
            box-shadow: inset 3px 3px 6px #c8c9d1, inset -3px -3px 6px #ffffff;
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #transcriptionBox {
            width: 100%;
            min-height: 250px;
            max-height: 400px;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            overflow-y: auto;
            background-color: #e6e7ee;
            box-shadow: inset 3px 3px 6px #c8c9d1, inset -3px -3px 6px #ffffff;
            font-weight: 300;
            line-height: 1.5;
        }

        .status-container {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .status {
            font-size: 0.9rem;
            color: #44476a;
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 3px 3px 6px #c8c9d1, -3px -3px 6px #ffffff;
            display: inline-block;
            font-weight: 400;
        }

        #wsStatus {
            font-weight: 500;
        }

        .connected {
            color: #3a9679;
        }

        .disconnected {
            color: #e53935;
        }

        .header {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #d1d9e6;
        }

        .subtitle {
            font-weight: 400;
            font-size: 1rem;
            color: #7b7f9e;
            margin-top: -15px;
            margin-bottom: 20px;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #e53935;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>STT Example for gyain</h1>
        <div class="subtitle">Real-time Speech Transcription</div>
    </div>

    <div id="controls">
        <button id="startBtn" onclick="startRecording()" disabled>
            <i class="fa-solid fa-microphone"></i> Start Recording
        </button>
        <button id="stopBtn" onclick="stopRecording()" disabled>
            <i class="fa-solid fa-stop"></i> Stop Recording
        </button>
    </div>

    <div id="transcriptionBox"></div>

    <div class="status-container">
        <div class="status">
            WebSocket Status:
            <span id="wsStatus" class="disconnected">Disconnected</span>
        </div>
    </div>

    <script>
        let websocket;
        let mediaStream;
        let audioContext;
        let processor;
        let isRecording = false;

        // Initialize WebSocket connection
        function initWebSocket() {
            websocket = new WebSocket("ws://localhost:8765");

            websocket.onopen = () => {
                console.log("WebSocket connected");
                const wsStatus = document.getElementById("wsStatus");
                wsStatus.textContent = "Connected";
                wsStatus.className = "connected";
                document.getElementById("startBtn").disabled = false;
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.text) {
                        console.log("Received transcription:", data.text);
                        const box = document.getElementById("transcriptionBox");
                        box.textContent += ` ${data.text}`;
                        box.scrollTop = box.scrollHeight;
                    }
                } catch (error) {
                    console.error("Error parsing message:", error);
                }
            };

            websocket.onclose = () => {
                const wsStatus = document.getElementById("wsStatus");
                wsStatus.textContent = "Disconnected";
                wsStatus.className = "disconnected";
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopBtn").disabled = true;

                // Make sure to remove active state and recording indicator
                const startBtn = document.getElementById("startBtn");
                startBtn.classList.remove("active");
                startBtn.innerHTML =
                    '<i class="fa-solid fa-microphone"></i> Start Recording';
            };
        }

        async function startRecording() {
            if (isRecording) return;

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                });
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(mediaStream);

                processor = audioContext.createScriptProcessor(4096, 1, 1);
                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (!websocket || websocket.readyState !== WebSocket.OPEN) return;

                    const audioData = convertFloat32ToInt16(
                        downsampleBuffer(
                            e.inputBuffer.getChannelData(0),
                            audioContext.sampleRate,
                            16384
                        )
                    );
                    websocket.send(audioData);
                };

                // Send configuration
                websocket.send(
                    JSON.stringify({
                        type: "config",
                        data: {
                            processing_args: {
                                chunk_length_seconds: 2.25,
                                chunk_offset_seconds: 0.05,
                            },
                        },
                    })
                );

                isRecording = true;
                document.getElementById("stopBtn").disabled = false;

                // Apply pressed effect and add recording indicator
                const startBtn = document.getElementById("startBtn");
                startBtn.disabled = true;
                startBtn.classList.add("active");
                startBtn.innerHTML =
                    '<span class="recording-indicator"></span><i class="fa-solid fa-microphone"></i> Recording...';
            } catch (error) {
                console.error("Error starting recording:", error);
            }
        }

        function stopRecording() {
            if (!isRecording) return;

            if (mediaStream)
                mediaStream.getTracks().forEach((track) => track.stop());
            if (processor) processor.disconnect();
            if (audioContext) audioContext.close();

            isRecording = false;

            // Remove pressed effect and recording indicator
            const startBtn = document.getElementById("startBtn");
            startBtn.disabled = false;
            startBtn.classList.remove("active");
            startBtn.innerHTML =
                '<i class="fa-solid fa-microphone"></i> Start Recording';

            document.getElementById("stopBtn").disabled = true;
        }

        // Audio processing utilities
        function downsampleBuffer(buffer, inputRate, outputRate) {
            const ratio = inputRate / outputRate;
            const newLength = Math.round(buffer.length / ratio);
            const result = new Float32Array(newLength);

            for (let i = 0; i < newLength; i++) {
                result[i] = buffer[Math.round(i * ratio)];
            }
            return result;
        }

        function convertFloat32ToInt16(buffer) {
            const int16Buffer = new Int16Array(buffer.length);
            for (let i = 0; i < buffer.length; i++) {
                int16Buffer[i] = Math.min(1, buffer[i]) * 0x7fff;
            }
            return int16Buffer.buffer;
        }

        // Initialize when page loads
        window.onload = initWebSocket;
    </script>
</body>

</html>